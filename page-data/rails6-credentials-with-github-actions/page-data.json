{"componentChunkName":"component---src-templates-blog-post-js","path":"/rails6-credentials-with-github-actions/","result":{"data":{"site":{"siteMetadata":{"title":"Life, Universe and Everything"}},"markdownRemark":{"id":"b4d87021-33dc-56f8-9e88-fbea1a9f0340","excerpt":"Rails 6 introduced a very nice concept of master key, which enables us to push credentials in the form of encrypted files in source control. Now whileâ€¦","html":"<p>Rails 6 introduced a very nice concept of master key, which enables us to push credentials in the form of encrypted files in source control.</p>\n<p>Now while integrating Github actions for the specs, or, linters in our code, we might come across pieces of codes where we need to decrypt the credentials.</p>\n<p>Decrypting credentials need the master key, which, we, of course, do not push in our source control.</p>\n<p>An example of the above scenario can be depicted as:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token comment\"># sign_up_controller.rb</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">SignUpController</span> <span class=\"token operator\">&lt;</span> <span class=\"token constant\">ApplicationController</span>\n  <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">index</span></span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token constant\">SignUpMailer</span><span class=\"token punctuation\">.</span>notify<span class=\"token punctuation\">(</span>email<span class=\"token punctuation\">:</span> email<span class=\"token punctuation\">,</span> otp<span class=\"token punctuation\">:</span> otp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>deliver_now\n  <span class=\"token keyword\">end</span>\n\n<span class=\"token comment\"># sign_up_mailer.rb</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">SignUpMailer</span> <span class=\"token operator\">&lt;</span> <span class=\"token constant\">ApplicationMailer</span>\n  <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">notify</span></span><span class=\"token punctuation\">(</span>email<span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> otp<span class=\"token punctuation\">:</span><span class=\"token punctuation\">)</span>\n    mail<span class=\"token punctuation\">(</span>to<span class=\"token punctuation\">:</span> email<span class=\"token punctuation\">,</span> subject<span class=\"token punctuation\">:</span> <span class=\"token string\">'Please verify your email'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span>\n\n<span class=\"token comment\">#application_mailer.rb</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">ApplicationMailer</span> <span class=\"token operator\">&lt;</span> <span class=\"token constant\">ActionMailer</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">Base</span>\n  default from<span class=\"token punctuation\">:</span> <span class=\"token constant\">Rails</span><span class=\"token punctuation\">.</span>application<span class=\"token punctuation\">.</span>credentials<span class=\"token punctuation\">.</span>dig<span class=\"token punctuation\">(</span><span class=\"token symbol\">:gmail</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">:user_name</span><span class=\"token punctuation\">)</span>\n  layout <span class=\"token string\">'mailer'</span>\n<span class=\"token keyword\">end</span>\n\n<span class=\"token comment\"># now the spec</span>\n<span class=\"token comment\"># sign_up_controller_spec.rb</span>\n<span class=\"token constant\">RSpec</span><span class=\"token punctuation\">.</span>describe <span class=\"token constant\">SignUpController</span><span class=\"token punctuation\">,</span> type<span class=\"token punctuation\">:</span> <span class=\"token symbol\">:controller</span> <span class=\"token keyword\">do</span>\n  describe <span class=\"token string\">'GET #index'</span> <span class=\"token keyword\">do</span>\n    it <span class=\"token string\">'sends a verification e-mail'</span> <span class=\"token keyword\">do</span>\n      get <span class=\"token symbol\">:index</span>\n      <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token keyword\">end</span>\n  <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<p>If we have Github actions configured, we will have the following error if we run the above spec</p>\n<blockquote>\n<p>SMTP From address may not be blank: nil</p>\n</blockquote>\n<p>The reason is Github actions can not decrypt the <code class=\"language-text\">user_name</code> key in <code class=\"language-text\">gmail</code> hash here, as it does not have the master key:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token constant\">Rails</span><span class=\"token punctuation\">.</span>application<span class=\"token punctuation\">.</span>credentials<span class=\"token punctuation\">.</span>dig<span class=\"token punctuation\">(</span><span class=\"token symbol\">:gmail</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">:user_name</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>To solve this error, we need to add this key as <strong>Repository Secrets</strong> in Github settings, which can be found at project settings > secrets.</p>\n<p>After adding the master key to Github secrets, the above specs run smoothly.</p>","frontmatter":{"title":"Rails master key within Github actions","date":"March 12, 2021","description":"Welcome to my very first post!"}},"previous":null,"next":null},"pageContext":{"id":"b4d87021-33dc-56f8-9e88-fbea1a9f0340","previousPostId":null,"nextPostId":null}},"staticQueryHashes":["1629091218","2841359383"]}